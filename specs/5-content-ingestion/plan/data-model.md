# Data Model: Content Ingestion & Embeddings

**Feature**: 5-content-ingestion
**Created**: 2025-12-21
**Status**: Draft

## Content Chunk Entity

**Description**: Represents a segment of extracted text from the book with source metadata

### Fields
- `id` (string, required): Unique identifier for the chunk (UUID)
- `content` (string, required): The actual text content (max 500 tokens/1500 chars)
- `source_url` (string, required): Original URL where content was found
- `title` (string, required): Page title or section header from source
- `position` (integer, required): Sequential position in the original document
- `hierarchy_path` (string, optional): Document hierarchy (e.g., "Chapter 1/Section 2")
- `metadata` (dict, optional): Additional metadata dictionary
  - `page_title` (string): Full page title
  - `section_headers` (list): Array of section headers in chunk
  - `word_count` (integer): Number of words in chunk
  - `language` (string): Detected language code
- `created_at` (datetime, required): Timestamp of creation
- `updated_at` (datetime, optional): Timestamp of last update

### Validation Rules
- `content` must not exceed 1500 characters or 500 tokens
- `source_url` must be a valid URL format
- `position` must be non-negative integer
- `title` must not be empty

## Embedding Vector Entity

**Description**: Numerical representation of content chunk generated by Cohere model

### Fields
- `chunk_id` (string, required): Reference to the content chunk (foreign key)
- `vector` (list[float], required): The embedding vector array (1024 dimensions)
- `vector_size` (integer, required): Dimension of the embedding (1024 for Cohere v3)
- `model_used` (string, required): Cohere model identifier (e.g., "embed-multilingual-v3.0")
- `model_version` (string, optional): Specific version of the model
- `created_at` (datetime, required): Timestamp of embedding creation
- `updated_at` (datetime, optional): Timestamp of last update

### Validation Rules
- `vector` must have exactly 1024 elements (for Cohere v3)
- `vector_size` must match actual vector length
- `model_used` must be valid Cohere model identifier
- `chunk_id` must reference an existing content chunk

## Ingestion Record Entity

**Description**: Tracks the status and metadata of content ingestion process

### Fields
- `id` (string, required): Unique identifier for the ingestion run (UUID)
- `source_url` (string, required): Root URL being ingested
- `status` (enum, required): Current status (pending, processing, completed, failed)
- `total_pages` (integer, required): Total number of pages identified for processing
- `processed_pages` (integer, required): Number of pages successfully processed
- `total_chunks` (integer, required): Total number of content chunks created
- `stored_vectors` (integer, optional): Number of vectors successfully stored in Qdrant
- `start_time` (datetime, required): When ingestion started
- `end_time` (datetime, optional): When ingestion completed (null if not finished)
- `progress_percentage` (float, optional): Completion percentage (0-100)
- `error_log` (string, optional): Any errors encountered during ingestion
- `metadata` (dict, optional): Additional ingestion metadata
  - `chunk_size` (integer): Size of chunks used
  - `overlap_size` (integer): Overlap between chunks
  - `total_tokens` (integer): Total tokens processed
  - `embedding_model` (string): Model used for embeddings

### Validation Rules
- `status` must be one of the allowed enum values
- `total_pages` and `processed_pages` must be non-negative
- `processed_pages` cannot exceed `total_pages`
- `progress_percentage` must be between 0 and 100
- `start_time` must be before `end_time` (if end_time exists)

## Relationships

### Content Chunk → Embedding Vector
- One-to-one relationship: Each content chunk has one corresponding embedding vector
- Foreign key: `chunk_id` in Embedding Vector references `id` in Content Chunk

### Ingestion Record → Content Chunk
- One-to-many relationship: Each ingestion record can create multiple content chunks
- Foreign key: Implicit through `source_url` and ingestion tracking

## State Transitions (Ingestion Record)

### Status Transitions
- `pending` → `processing`: When ingestion starts
- `processing` → `completed`: When all pages are processed successfully
- `processing` → `failed`: When an unrecoverable error occurs
- `failed` → `processing`: When retry is initiated (optional)

### Progress Updates
- `progress_percentage` updates incrementally as pages are processed
- `processed_pages` increments as each page completes
- `total_chunks` updates after all pages are processed
- `stored_vectors` updates as vectors are stored in Qdrant